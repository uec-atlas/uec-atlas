---
import LinkCardList from "@/components/dataview/LinkCardList.astro";
import Heading1 from "@/components/Heading1.astro";
import DataRepositoryLayout from "@/layouts/DataRepositoryLayout.astro";
import { expandURI, toFullURL } from "@/utils/url";

const query = Astro.url.searchParams.get("q") || "";
const searchWords = query.trim().split(/\s+/).filter(Boolean);
const escapedWords = searchWords.map((word) =>
  word.replace(/\\/g, "\\\\").replace(/"/g, '\\"'),
);

const sparqlQuery = `
PREFIX schema: <http://schema.org/>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX uao: <${expandURI("uao:")}>

SELECT
  ?sub
  (SAMPLE(?nJa) AS ?nameJa)
  (SAMPLE(?nEn) AS ?nameEn)
  (SAMPLE(?t) AS ?type)
WHERE {
  {
    # 1. まずキーワードに一致するIDだけを100件抜く
    SELECT DISTINCT ?sub WHERE {
      ?sub a uao:NamedThing .
      ?sub ?p ?text .
      FILTER(?p IN (schema:name, schema:description, schema:alternateName))
      ${escapedWords.map((word) => `FILTER(CONTAINS(LCASE(STR(?text)), LCASE("${word}")))`).join("\n")}
    }
  }

  ?sub rdf:type ?t .
  OPTIONAL { ?sub schema:name ?nJa . FILTER(lang(?nJa) = "ja") }
  OPTIONAL { ?sub schema:name ?nEn . FILTER(lang(?nEn) = "en") }

  FILTER NOT EXISTS {
    ?sub rdf:type ?other .
    ?other rdfs:subClassOf+ ?t .
    FILTER (?other != ?t)
  }
}
GROUP BY ?sub LIMIT 100
`;

const searchResult = await Astro.locals.runtime.env.SELF.fetch(
  toFullURL("/sparql"),
  {
    method: "POST",
    headers: {
      Accept: "application/sparql-results+json",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({ query: sparqlQuery }),
  },
).then((res) => res.json());

interface SearchResultBinding {
  sub: { value: string };
  nameJa: { value: string };
  nameEn: { value: string };
  type: { value: string };
}

const results = (searchResult.results.bindings as SearchResultBinding[])
  .map((binding) => {
    const nameJa = binding.nameJa?.value || "";
    const nameEn = binding.nameEn?.value || "";

    let maxRatio = 0;
    searchWords.forEach((word) => {
      const w = word.toLowerCase();
      if (nameJa?.toLowerCase().includes(w)) {
        maxRatio = Math.max(maxRatio, w.length / nameJa.length);
      }
      if (nameEn?.toLowerCase().includes(w)) {
        const ratio = (w.length / nameEn.length) * 0.8;
        maxRatio = Math.max(maxRatio, ratio);
      }
    });

    return {
      id: binding.sub.value,
      name: { ja: nameJa, en: nameEn },
      type: binding.type.value,
      ratioScore: maxRatio,
    };
  })
  .sort((a, b) => a.name.ja.localeCompare(b.name.ja, "ja"))
  .sort((a, b) => b.ratioScore - a.ratioScore);
---

<DataRepositoryLayout title={`"${query}"の検索結果`}>
  <Heading1>
    <span>"{query}"の検索結果</span>
  </Heading1>

  {
    results.length === 0 ? (
      <p>結果が見つかりませんでした。</p>
    ) : (
      <LinkCardList
        items={results.map((item) => ({
          uri: item.id,
          name: item.name,
          tags: [item.id.match(/organizations|spatial/)?.[0]].filter(
            (v): v is string => !!v,
          ),
        }))}
        fallbackName={{
          ja: "無名の要素",
          en: "Unnamed Result",
        }}
      />
    )
  }
</DataRepositoryLayout>
